import{j as e,r as g,t as ne,ax as k,as as oe}from"./index-e9055987.js";import{a as w,F as ie}from"./FormItem-ea0b05bc.js";import{B as T}from"./Button-ba65fcd6.js";import{R as ce,S as le,A as de}from"./index.esm-ac6f3d99.js";import{C as se}from"./ConfirmDialog-d3517bf8.js";import{b as S,F as ue,a as me}from"./formik.esm-026afa26.js";import{A as B}from"./AdaptableCard-459786db.js";import{I as D}from"./Input-cff490ba.js";import{N as pe}from"./react-number-format.es-1ce1616c.js";import"./Alert-102e0217.js";import"./index-48bcc748.js";import"./Badge-9568a8b0.js";import"./Card-433b6df5.js";import{C as K}from"./index-0b16cfb5.js";import"./index-6ec4b8b8.js";import{D as ae}from"./Dialog-0f29b530.js";import"./Drawer-1d10f851.js";import"./ScrollBar-7cb0876a.js";import"./index-cba86877.js";import"./index-fd641029.js";import"./toast-38b8809c.js";import"./Skeleton-ede84c2e.js";import{P as he}from"./index-6bfd69bd.js";import"./index-ca92c429.js";import{S as M}from"./Select-3959542b.js";import{S as ge}from"./Switcher-fc6ab2a0.js";import"./index-95867d9f.js";import"./index-470afdad.js";import"./Tag-0c9ab60f.js";import"./index-b1813226.js";import"./Tooltip-c9ef7fc2.js";import"./Upload-73c59612.js";import{s as xe}from"./AttributeService-ad28792a.js";import{a5 as fe,a6 as be,U as je}from"./index.esm-1ac4f407.js";import{c as ve}from"./cloneDeep-860e24f8.js";import{U as te}from"./index-a547e199.js";import{c as Q,a as V,b as I,d as Y}from"./index.esm-6e43d029.js";import{c as ye}from"./createLucideIcon-35c01f3b.js";import{X as Ne}from"./x-663813fb.js";/**
 * @license lucide-react v0.436.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=ye("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]),Ce=c=>{const{touched:r,errors:s}=c;return e.jsxs(B,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Información del Producto"}),e.jsx("p",{className:"mb-6",children:"Parte de información Básica"}),e.jsx(w,{label:"Nombre del Producto",invalid:s.name&&r.name,errorMessage:s.name,children:e.jsx(S,{type:"text",autoComplete:"off",name:"name",placeholder:"Nombre",component:D})}),e.jsx(w,{label:"Description",labelClass:"!justify-start",invalid:s.description&&r.description,errorMessage:s.description,children:e.jsx(S,{name:"description",children:({field:t,form:x})=>e.jsx(ce,{value:t.value,onChange:m=>x.setFieldValue(t.name,m)})})}),e.jsx(w,{label:"Cantidad del Producto Disponible",invalid:s.stock&&r.stock,errorMessage:s.stock,children:e.jsx(S,{type:"text",autoComplete:"off",name:"stock",placeholder:"Cantidad Disponible",component:D})})]})},X=c=>e.jsx(D,{...c,value:c.field.value,prefix:"$"}),L=({onValueChange:c,...r})=>e.jsx(pe,{customInput:D,type:"text",autoComplete:"off",onValueChange:c,...r}),we=c=>{const{values:r,touched:s,errors:t}=c,[x,m]=g.useState(r.commission_type==="percentage"?"%":"$"),l=[{value:"percentage",label:"Porcentaje"},{value:"fixed",label:"Fijo"}],u=[{value:"simple",label:"Simple"},{value:"variable",label:"Variable"}],[N,f]=g.useState([{value:"CUP",label:"CUP"},{value:"USD",label:"USD"},{value:"EURO",label:"EURO"}]);g.useEffect(()=>{(async()=>{const n=await xe.getCurrencies().then(o=>J(o));return f(n),[]})()},[]);const C=[{value:"manufactured",label:"Manufacturado"},{value:"imported",label:"Importado"}];return g.useEffect(()=>{console.log(r),m(r.commission_type==="percentage"?"%":"$")},[r.commission_type]),e.jsxs(B,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Sistema de Precios"}),e.jsx("p",{className:"mb-6",children:"Configuración de Precios"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Tipo de Producto",invalid:t.type&&s.type,errorMessage:t.type,children:e.jsx(S,{name:"type",children:({field:a,form:n})=>e.jsx(M,{field:a,form:n,options:u,value:u.find(o=>o.value===r.type),onChange:o=>{console.log(a.name,a.value),n.setFieldValue(a.name,o==null?void 0:o.value)}})})})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Tipo de Producto",invalid:t.origin&&s.origin,errorMessage:t.origin,children:e.jsx(S,{name:"origin",children:({field:a,form:n})=>e.jsx(M,{field:a,form:n,options:C,value:C.find(o=>o.value===r.origin),onChange:o=>{console.log(a.name,a.value),n.setFieldValue(a.name,o==null?void 0:o.value)}})})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Moneda de Referencia",invalid:t.reference_currency&&s.reference_currency,errorMessage:t.reference_currency,children:e.jsx(S,{name:"reference_currency",children:({field:a,form:n})=>e.jsx(M,{field:a,form:n,options:N,value:N.find(o=>o.value===r.reference_currency),onChange:o=>n.setFieldValue(a.name,o==null?void 0:o.value)})})})})]}),r.origin==="imported"&&e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Costo del Producto",invalid:t.cost&&s.cost,errorMessage:t.cost,children:e.jsx(S,{name:"cost",children:({field:a,form:n})=>e.jsx(L,{form:n,field:a,placeholder:"Costo del producto importado",customInput:X,onValueChange:o=>n.setFieldValue(a.name,o.value)})})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Precio Estándar",invalid:t.standard_price&&s.standard_price,errorMessage:t.standard_price,children:e.jsx(S,{name:"standard_price",children:({field:a,form:n})=>e.jsx(L,{form:n,field:a,placeholder:"Precio estándar",customInput:X,onValueChange:o=>n.setFieldValue(a.name,o.value)})})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Descuento",invalid:t.discount&&s.discount,errorMessage:t.discount,children:e.jsx(S,{name:"discount",children:({field:a,form:n})=>e.jsx(L,{form:n,field:a,placeholder:"(Si desea que aparezca)",customInput:X,onValueChange:o=>{m(r.commission_type==="percentage"?"%":"$"),n.setFieldValue(a.name,o.value)}})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Tipo de Comisión",invalid:t.commission_type&&s.commission_type,errorMessage:t.commission_type,children:e.jsx(S,{name:"commission_type",children:({field:a,form:n})=>e.jsx(M,{field:a,form:n,options:l,value:l.find(o=>o.value===r.commission_type),onChange:o=>{n.setFieldValue(a.name,o.value),m(r.commission_type==="percentage"?"%":"$")}})})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Comisión",invalid:t.commission&&s.commission,errorMessage:t.commission,children:e.jsx(S,{name:"commission",children:({field:a,form:n})=>e.jsx(L,{form:n,field:a,value:r.commission,placeholder:"Comisión",customInput:D,onValueChange:o=>n.setFieldValue(a.name,o.value),prefix:x})})})})]})]})},Z=[{label:"Masculino",value:"masculino"},{label:"Femenino",value:"femenino"},{label:"Unisex",value:"unisex"}],ee=[{value:0,label:"Nuevo"},{value:1,label:"Agotado"},{value:2,label:"En existencia"},{value:3,label:"Descontinuado"}],Se=c=>{const{values:r={category_id:"",brand:"",gender:""},touched:s,errors:t,categories:x}=c;return e.jsxs(B,{divider:!0,className:"mb-4",children:[e.jsx("h5",{children:"Organización"}),e.jsx("p",{className:"mb-6",children:"Configurar como se organiza el producto"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Categoría",invalid:t.category_id&&s.category_id,errorMessage:t.category_id,children:e.jsx(S,{name:"category_id",children:({field:m,form:l})=>e.jsx(M,{field:m,form:l,options:x,value:x.filter(u=>u.value===r.category_id),onChange:u=>l.setFieldValue(m.name,u==null?void 0:u.value)})})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Estado en Inventario",invalid:t.status&&s.status,errorMessage:t.status,children:e.jsx(S,{name:"status",children:({field:m,form:l})=>e.jsx(M,{field:m,form:l,options:ee,value:ee.filter(u=>u.value===r.status),onChange:u=>{l.setFieldValue(m.name,u==null?void 0:u.value)}})})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Género",invalid:t.gender&&s.gender,errorMessage:t.gender,children:e.jsx(S,{name:"gender",children:({field:m,form:l})=>e.jsx(M,{field:m,form:l,options:Z,value:Z.filter(u=>u.value===r.gender),onChange:u=>l.setFieldValue(m.name,u==null?void 0:u.value)})})})}),e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"Marca",invalid:t.brand&&s.brand,errorMessage:t.brand,children:e.jsx(S,{type:"text",autoComplete:"off",name:"brand",placeholder:"Marca",component:D})})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsx("div",{className:"col-span-1",children:e.jsx(w,{label:"¿Es Visible para todos?",className:"flex justify-center items-center",children:e.jsxs("div",{className:"flex gap-5",children:[e.jsx("p",{children:"No"}),e.jsx(ge,{name:"isVisible"}),e.jsx("p",{children:"Si"})]})})})})]})},ke=c=>{const{images:r,onImageDelete:s}=c,[t,x]=g.useState({}),[m,l]=g.useState(!1),[u,N]=g.useState(!1),f=_=>{x(_),l(!0)},C=()=>{l(!1),setTimeout(()=>{x({})},300)},a=_=>{x(_),N(!0)},n=()=>{x({}),N(!1)},o=()=>{s==null||s(t),N(!1)};return e.jsxs(e.Fragment,{children:[r.map((_,O)=>e.jsxs("div",{className:"group relative rounded border p-2 flex",children:[e.jsx("img",{className:"rounded max-h-[140px] max-w-full",src:_,alt:""}),e.jsxs("div",{className:"absolute inset-2 bg-gray-900/[.7] group-hover:flex hidden text-xl items-center justify-center",children:[e.jsx("span",{className:"text-gray-100 hover:text-gray-300 cursor-pointer p-1.5",onClick:()=>f(_),children:e.jsx(fe,{})}),e.jsx("span",{className:"text-gray-100 hover:text-gray-300 cursor-pointer p-1.5",onClick:()=>a(_),children:e.jsx(be,{})})]})]},O)),e.jsx(ae,{isOpen:m,onClose:C,onRequestClose:C,children:e.jsx("img",{className:"w-full",src:t,alt:"img"})}),e.jsx(se,{isOpen:u,type:"danger",title:"Remove image",confirmButtonColor:"red-600",onClose:n,onRequestClose:n,onCancel:n,onConfirm:o,children:e.jsx("p",{children:" Are you sure you want to remove this image? "})})]})},Ee=c=>{const{localImages:r,setLocalImages:s}=c,[t,x]=g.useState(!1),[m,l]=g.useState(0),[u,N]=g.useState();function f(a,n,o){if(a){N(a),o.close({quiet:!0});return}s(_=>{var O;return[..._,(O=n==null?void 0:n.info)==null?void 0:O.secure_url]})}g.useEffect(()=>{const a=setInterval(()=>{l(n=>{if(n===87)return clearInterval(a),100;if(n>50)return n+1;if(n>50)return n+2})},900);return()=>clearInterval(a)},[]);const C=(a,n,o)=>{let _=ve(r);_=_.filter(O=>O!==o),s(_)};return e.jsxs(B,{className:"mb-4",children:[e.jsx("h5",{children:"Imagen del Producto"}),e.jsx("p",{className:"mb-6",children:"Añade imagen o cambiala"}),e.jsx(w,{children:e.jsx(S,{name:"images",es:!0,children:({field:a,form:n})=>e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3 gap-4",children:[e.jsx(ke,{images:r,onImageDelete:o=>C(n,a,o)}),e.jsx(te,{onUpload:f,children:({open:o})=>{function _(O){O.preventDefault(),o()}return e.jsx("button",{onClick:_,children:"Subir Imagen"})}})]})})}),t&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{percent:m}),e.jsx(ne,{})]})]})},re={getAttributes:async()=>{const{data:c,error:r}=await k.from("attributes").select("id, name, values:attribute_values(id, value)");if(r)throw r;return c},getCurrencies:async()=>{const{data:c,error:r}=await k.from("currency").select("*");if(r)throw r;return c},uploadImage:async c=>{const{data:r,error:s}=await k.storage.from("product-images").upload(`${Date.now()}-${c.name}`,c);if(s)throw s;const{publicURL:t,error:x}=k.storage.from("product-images").getPublicUrl(r.path);if(x)throw x;return t}};function Oe({onVariationsChange:c=()=>{},variations:r,setVariations:s}){const[t,x]=g.useState([]),[m,l]=g.useState([]),[u,N]=g.useState({}),[f,C]=g.useState(null),[a,n]=g.useState(!1);g.useState(!1),g.useState(0);const[o,_]=g.useState(),[O,U]=g.useState({}),[z,G]=g.useState(!1),A=i=>{U(i),G(!0)},$=()=>{G(!1),setTimeout(()=>{U({})},300)};g.useEffect(()=>{(async()=>{const p=await re.getAttributes(),d=await re.getCurrencies();x(p),l(d),C(d[0])})()},[]),g.useEffect(()=>{c(r)},[r,c]);const H=(i,p,d)=>{N(h=>{const j=d?[...h[i]||[],p]:(h[i]||[]).filter(y=>y!==p);return{...h,[i]:j}})},E=()=>{const i=Object.entries(u).filter(([j,y])=>y.length>0).map(([j,y])=>({attribute:t.find(v=>v.id===Number(j)),values:y.map(v=>t.find(F=>F.id===Number(j)).values.find(F=>F.id===v))}));if(i.length===0){alert("Por favor, seleccione al menos un valor de atributo.");return}const p=(j,y)=>{if(j===i.length)return[y];const v=[];for(const F of i[j].values)v.push(...p(j+1,[...y,F]));return v},h=p(0,[]).map((j,y)=>({product_id:1,name:j.map(v=>v.value).join(" - "),price:0,stock:0,created_at:new Date().toISOString(),pictures:[],currency_id:1,attributes:j}));s(h)},b=(i,p,d)=>{s(h=>h.map((j,y)=>y===i?{...j,[p]:d}:j))},P=async(i,p,d,h)=>{if(console.log("VIDEO"),i){_(i),d.close({quiet:!0});return}s(y=>{const v={...y[h]};return v.pictures=[...v.pictures,"loading"],y.map((F,W)=>W===h?v:F)});const j=p;s(y=>{const v={...y[h]};return v.pictures=v.pictures.map(F=>F==="loading"?j:F),y.map((F,W)=>W===h?v:F)}),console.log("Final",r[h])},R=(i,p)=>{s(d=>d.map((h,j)=>j===i?{...h,pictures:h.pictures.filter((y,v)=>v!==p)}:h))},q=i=>{const p=m.find(d=>d.id===Number(i));p&&(C(p),s(d=>d.map(h=>h.currency_id===(f==null?void 0:f.id)?{...h,currency_id:p==null?void 0:p.id}:h)))};return e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Generador de Variaciones de Producto"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Seleccione los atributos:"}),t.map(i=>e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:i.name}),e.jsx("div",{className:"flex flex-wrap gap-4",children:i.values.map(p=>{var d;return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(K,{id:`attr-${i.id}-${p.id}`,checked:((d=u[i.id])==null?void 0:d.includes(p.id))||!1,onChange:h=>H(i.id,p.id,h===!0)}),e.jsx("label",{htmlFor:`attr-${i.id}-${p.id}`,className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:p.value})]},p.id)})})]},i.id))]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Seleccione la moneda:"}),e.jsxs("select",{className:"w-full p-2 border border-gray-300 rounded-md",value:(f==null?void 0:f.id)||"",onChange:i=>q(i.target.value),children:[e.jsx("option",{value:"",children:"Seleccione una moneda"}),m.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]})]}),e.jsxs("div",{className:"mb-6 flex items-center space-x-2",children:[e.jsx(K,{checked:a,onChange:n,id:"requires-stock"}),e.jsx("label",{htmlFor:"requires-stock",className:"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:"Producto requiere control de stock"})]}),e.jsx(T,{type:"button",onClick:E,className:"mb-6",children:"Generar Variaciones"}),r.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Variaciones Generadas:"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 px-4 border-b text-left",children:"Nombre"}),e.jsx("th",{className:"py-2 px-4 border-b text-left",children:"Precio"}),a&&e.jsx("th",{className:"py-2 px-4 border-b text-left",children:"Stock"}),e.jsx("th",{className:"py-2 px-4 border-b text-left",children:"Moneda"}),e.jsx("th",{className:"py-2 px-4 border-b text-left",children:"Imágenes"})]})}),e.jsx("tbody",{children:r.map((i,p)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"py-2 px-4 border-b",children:e.jsx(D,{value:i.name,onChange:d=>b(p,"name",d.target.value)})}),e.jsx("td",{className:"py-2 px-4 border-b",children:e.jsx(D,{type:"number",value:i.price,onChange:d=>b(p,"price",Number(d.target.value)),className:"w-24"})}),a&&e.jsx("td",{className:"py-2 px-4 border-b",children:e.jsx(D,{type:"number",value:i.stock,onChange:d=>b(p,"stock",Number(d.target.value)),className:"w-24"})}),e.jsx("td",{className:"py-2 px-4 border-b",children:e.jsx("select",{className:"w-full p-2 border border-gray-300 rounded-md",value:i.currency_id,onChange:d=>b(p,"currency_id",m.find(h=>h.id===Number(d.target.value)).id),children:m.map(d=>e.jsx("option",{value:d.id,children:d.name},d.id))})}),e.jsx("td",{className:"py-2 px-4 border-b",children:e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[i.pictures.map((d,h)=>e.jsx("div",{className:"relative",children:d==="loading"?e.jsx("div",{className:"w-16 h-16 flex items-center justify-center bg-gray-200 rounded",children:e.jsx(_e,{className:"h-6 w-6 animate-spin"})}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:d,alt:`Variation ${p+1}`,className:"w-16 h-16 object-cover rounded",onClick:()=>A(d)}),e.jsx("button",{onClick:()=>R(p,h),className:"absolute top-0 right-0 bg-red-500 text-white rounded-full p-1","aria-label":"Remove image",children:e.jsx(Ne,{className:"h-4 w-4"})})]})},h)),e.jsx(te,{onUpload:(d,h,j)=>{var v;const y=(v=h==null?void 0:h.info)==null?void 0:v.secure_url;P(d,y,j,p)},children:({open:d})=>{function h(j){j.preventDefault(),d()}return e.jsx("label",{className:"w-16 h-16 flex items-center justify-center bg-gray-200 rounded cursor-pointer",children:e.jsx("button",{onClick:h,children:e.jsx("span",{className:"text-4xl text-gray-500",children:"+"})})})}})]})})]},p))})]})})]})," ",e.jsx(ae,{isOpen:z,onClose:$,onRequestClose:$,children:e.jsx("img",{className:"w-full",src:O,alt:"img"})})]})}const Pe=async(c,r)=>{try{const{data:s,error:t}=await k.from("products").insert([{...c}]).select("*").single();if(t)throw t;if(r&&r.length>0){const x=r.map(f=>({name:f.name,price:f.price,stock:f.stock,pictures:f.pictures,product_id:s.id,currency_id:f.currency_id})),{data:m,error:l}=await k.from("product_variations").insert(x).select("id, name"),u=r.flatMap(f=>f.attributes.map(C=>m.map(a=>({product_variation_id:a.id,attribute_value_id:C.id}))).flat()).flat();if(l)throw l;const{error:N}=await k.from("product_variation_attributes").insert(u);if(l)throw l}return{}}catch(s){throw console.error("Error creating product:",s),s}},Fe=async(c,r,s)=>{try{let t;if(r){const x=await k.from("product_variations").select("id").eq("product_id",r);await k.from("product_variation_attributes").delete().in("product_variation_id",x.data.map(u=>u.id)),await k.from("product_variations").delete().eq("product_id",r),delete c.id;const{data:m,error:l}=await k.from("products").update(c).eq("id",r).single();if(l)throw l;if(t=m,console.log(s),console.log(s.map(u=>u.currency)),s&&s.length>0){const u=s.map(a=>({name:a.name,price:a.price,stock:a.stock,pictures:a.pictures,product_id:r,currency_id:a.currency_id})),{error:N}=await k.from("product_variations").insert(u);if(N)throw N;const f=s.flatMap(a=>a.attributes.map(n=>({product_variation_id:a.id,attribute_value_id:n.id})));console.log(f);const{error:C}=await k.from("product_variation_attributes").insert(f);if(C)throw C}}return t}catch(t){throw console.error("Error updating/upserting product:",t),t}},Ie=async c=>{try{const{data:r,error:s}=await k.from("products").select("*").eq("id",c).single();if(console.log("GOL",r),s)throw s;const{data:t,error:x}=await k.from("product_variations").select(`
        *,
        product_variation_attributes (
          attribute_value_id (
            *
          ),
          product_variation_id(
          *,
          currency_id(*)
          )
        )
      `).eq("product_id",c);if(x)throw x;const m=t.map(l=>{const u=l.product_variation_attributes.map(N=>N.attribute_value_id);return{id:l.id,product_id:l.product_id,name:l.name,price:l.price,stock:l.stock,created_at:l.created_at,pictures:l.pictures,currency_id:l.currency_id,attributes:u,currency:l.currency_id}});return{...r,variations:m}}catch(r){throw console.error("Error fetching product:",r),r}};function J(c){return c.map(r=>({...r,label:r.name,value:r.id}))}const Ve=Q().shape({name:V().required("El nombre es requerido"),description:V().nullable(),category_id:I().nullable(),shop_id:I().nullable(),cost:I().min(0,"El costo no puede ser negativo"),discount:I().min(0,"El descuento no puede ser negativo").max(100,"El descuento no puede ser mayor a 100%"),state:V().oneOf(["available","unavailable"]),gender:V().nullable(),commission:I().min(0,"La comisión no puede ser negativa"),type:V().oneOf(["simple","variable"]),origin:V().oneOf(["manufactured","imported"]),commission_type:V().oneOf(["percentage","fixed"]),reference_currency:I().nullable(),owner_id:V().nullable(),standard_price:I().min(0,"El precio estándar no puede ser negativo"),status:I().oneOf([0,1,2,3]),variations:Y().of(Q().shape({name:V().required("El nombre de la variación es requerido"),price:I().min(0,"El precio no puede ser negativo").required("El precio es requerido"),stock:I().min(0,"El stock no puede ser negativo").required("El stock es requerido"),pictures:Y().of(V()),currency_id:I().nullable()}))}),De=({onDelete:c})=>{const[r,s]=g.useState(!1),t=()=>{s(!0)},x=()=>{s(!1)},m=()=>{c==null||c(s)};return e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"text-red-600",variant:"plain",size:"sm",icon:e.jsx(je,{}),type:"button",onClick:t,children:"Delete"}),e.jsx(se,{isOpen:r,type:"danger",title:"Delete product",confirmButtonColor:"red-600",onClose:x,onRequestClose:x,onCancel:x,onConfirm:m,children:e.jsx("p",{children:"Are you sure you want to delete this product? All record related to this product will be deleted as well. This action cannot be undone."})})]})},qe=g.forwardRef(c=>{const[r,s]=g.useState([{label:"",value:""}]),[t,x]=g.useState([{label:"",value:""}]),[m,l]=g.useState([]),[u,N]=g.useState(null),[f,C]=g.useState([]),a=oe(E=>E.auth.user),n=location.pathname.substring(location.pathname.lastIndexOf("/")+1)==="product-new"?!1:location.pathname.substring(location.pathname.lastIndexOf("/")+1),o=g.useRef(null),[_,O]=g.useState({name:"",description:null,category_id:null,shop_id:a.shopId,images:[],cost:0,discount:0,state:"available",gender:null,commission:0,type:null,origin:null,commission_type:"percentage",reference_currency:null,owner_id:null,standard_price:0,status:0});g.useEffect(()=>{console.log("HOL",n);async function E(){try{const{data:b,error:P}=await k.from("categories").select("*");if(P)throw P;const R=J(b.filter(i=>i.parent_id==null)),q=J(b.filter(i=>i.parent_id!==null));q.push({label:"Crear Nueva Subcategoría",value:"newSub"}),s(R),x(q)}catch(b){console.error("Error fetching categories:",b)}}return E(),n&&Ie(parseInt(n)).then(b=>{o.current.setValues(b),l(b.variations),delete b.variations,console.log("NUEVA",b),O(b)}).catch(b=>{console.log(b),N("No se encontró el producto")}),()=>{}},[]);const{type:U,initialData:z=_,onFormSubmit:G,onDiscard:A,onDelete:$}=c,H=async(E,{setSubmitting:b})=>{try{E.owner_id=a.id,E.images=f,n?await Fe(E,parseInt(n),m):await Pe(E,m),console.log("Formulario enviado exitosamente"),b(!1)}catch(P){console.error("Error al enviar formulario:",P),N("Ocurrió un error al enviar el formulario"),b(!1)}};return e.jsx(e.Fragment,{children:e.jsx(ue,{innerRef:o,initialValues:{...z},validationSchema:Ve,onSubmit:H,children:({values:E,touched:b,errors:P,isSubmitting:R,setFieldValue:q})=>e.jsx(me,{children:e.jsxs(ie,{children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2",children:[e.jsx(Ce,{touched:b,errors:P}),e.jsx(we,{touched:b,errors:P,values:E}),e.jsx(Se,{touched:b,errors:P,values:E,categories:r,subcategories:t,setFieldValue:q}),E.type!=="simple"&&e.jsx(Oe,{touched:b,errors:P,values:E,variations:m,setVariations:l,setFieldValue:q})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(Ee,{localImages:f,setLocalImages:C})})]}),e.jsxs(le,{className:"-mx-8 px-8 flex items-center justify-between py-4",stickyClass:"border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700",children:[e.jsx("div",{children:U==="edit"&&e.jsx(De,{onDelete:$})}),e.jsxs("div",{className:"md:flex items-center",children:[e.jsx(T,{size:"sm",className:"ltr:mr-3 rtl:ml-3",type:"button",onClick:()=>A==null?void 0:A(),children:"Discard"}),e.jsx(T,{size:"sm",variant:"solid",loading:R,icon:e.jsx(de,{}),type:"submit",children:n?"Actualizar Producto":"Crear Producto"})]})]})]})})})})});qe.displayName="ProductForm";export{qe as P};
