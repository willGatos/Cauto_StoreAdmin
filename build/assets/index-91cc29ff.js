import{r as c,ae as V,ax as l,j as e,aw as $}from"./index-e9055987.js";import{B}from"./Button-ba65fcd6.js";import{I as h}from"./Input-cff490ba.js";import{s as z}from"./AttributeService-ad28792a.js";import{U as W}from"./index-a547e199.js";import{C as G,a as H}from"./chevron-right-32c326f0.js";import"./Views-51136580.js";import"./isNil-1a93575e.js";import"./get-c3140d19.js";import"./_MapCache-0feb66c1.js";import"./createLucideIcon-35c01f3b.js";function ie(){const[g,P]=c.useState([]),[J,C]=c.useState(),[_,D]=c.useState([]),{id:p}=V(),[d,m]=c.useState({name:"",description:"",long_description:"",general_offer_price:0,startDate:"",endDate:"",shopId:1,products:[]}),[w,k]=c.useState({}),[y,b]=c.useState({}),[E,F]=c.useState([]),[v,u]=c.useState(!0);c.useEffect(()=>{S(),z.getCurrencies().then(P),p?O(parseInt(p)):u(!1)},[p]);const S=async()=>{const{data:r,error:t}=await l.from("products").select(`
        id,
        name,
        variations:product_variations (
          id,
          name
        )
      `);t?console.error("Error fetching products:",t):F(r||[])},O=async r=>{const{data:t,error:s}=await l.from("offers").select(`
        *,
        products:offer_products (
          id,
          product_id,
          variations:offer_product_variations (
            id,
            product_variation_id,
            offer_price,
            currency_id
          )
        )
      `).eq("id",r).single();if(s)console.error("Error fetching offer:",s);else if(t){const o={...t,startDate:t.start_date,endDate:t.end_date,shopId:t.shop_id,products:t.products.map(i=>({id:i.id,productId:i.product_id,variations:i.variations.map(n=>({id:n.id,variationId:n.product_variation_id,offer_price:n.offer_price,currencyId:n.currency_id}))}))};console.log(o),m(o);const a=o.products.map(i=>i.productId);b(a.reduce((i,n)=>(i[n]=!0,i),{}))}u(!1)},x=r=>{const{name:t,value:s}=r.target;m(o=>({...o,[t]:s}))},U=r=>{k(t=>({...t,[r]:!t[r]}))},q=(r,t)=>{b(s=>({...s,[r]:t})),m(t?s=>({...s,products:[...s.products,{productId:r,variations:[]}]}):s=>({...s,products:s.products.filter(o=>o.productId!==r)}))},N=(r,t,s,o)=>{m(a=>({...a,products:a.products.map(n=>n.productId===r?{...n,variations:[{variationId:t,offer_price:parseFloat(s)||0,currencyId:parseFloat(o)},...n.variations.filter(f=>f.variationId!==t)]}:n)}))},R=r=>{const t=d.products.find(i=>i.productId===r);if(!t||t.variations.length===0)return"N/A";const s=t.variations.map(i=>{const n=g.find(f=>f.id===i.currencyId);return n?i.offer_price*n.exchange_rate:0}),o=Math.min(...s),a=Math.max(...s);return m(i=>({...i,general_offer_price:o})),o===a?`${a.toFixed(2)} CUP`:`${a.toFixed(2)} - ${o.toFixed(2)} CUP`},M=async r=>{r.preventDefault(),u(!0);const t={name:d.name,description:d.description,long_description:d.long_description,general_offer_price:d.general_offer_price,start_date:d.startDate,end_date:d.endDate,shop_id:d.shopId,images:_};let s;if(p){const{data:a,error:i}=await l.from("offers").update(t).eq("id",p).select();if(i){console.error("Error updating offer:",i),u(!1);return}s=parseInt(p)}else{const{data:a,error:i}=await l.from("offers").insert(t).select();if(i){console.error("Error creating offer:",i),u(!1);return}s=a[0].id}const{data:o}=await l.from("offer_products").select("id").eq("offer_id",s);await l.from("offer_product_variations").delete().in("offer_product_id",o.map(a=>a.id));for(const a of d.products){const{data:i,error:n}=await l.from("offer_products").insert({offer_id:s,product_id:a.productId}).select();if(n){console.error("Error inserting offer product:",n);continue}const f=i[0].id,L=a.variations.map(j=>({offer_product_id:f,product_variation_id:j.variationId,offer_price:j.offer_price,currency_id:j.currencyId})),{error:I}=await l.from("offer_product_variations").insert(L);I&&console.error("Error inserting offer product variations:",I)}u(!1)};if(v)return e.jsx("div",{children:"Loading..."});const A=async(r,t,s)=>{if(console.log("VIDEO"),console.log(t,r),r){C(r),s.close({quiet:!0});return}D(o=>[...o,t])};return e.jsxs("form",{onSubmit:M,className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[" ",e.jsx("div",{className:"group relative rounded border p-2 flex",children:_.map(r=>e.jsx("img",{className:"rounded max-h-[140px] max-w-full",src:r,alt:""}))})]}),e.jsx("h5",{children:"Imagenes"}),e.jsx(W,{onUpload:(r,t,s)=>{var a;const o=(a=t==null?void 0:t.info)==null?void 0:a.secure_url;A(r,o,s)},children:({open:r})=>{function t(s){s.preventDefault(),r()}return e.jsx("label",{className:"w-16 h-16 flex items-center justify-center bg-gray-200 rounded cursor-pointer",children:e.jsx("button",{onClick:t,children:e.jsx("span",{className:"text-4xl text-gray-500",children:"+"})})})}}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700",children:"Nombre de la oferta"}),e.jsx(h,{id:"name",name:"name",value:d.name,onChange:x,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Descripción"}),e.jsx(h,{id:"description",name:"description",value:d.description,onChange:x,rows:3})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-gray-700",children:"Descripción"}),e.jsx(h,{id:"long_description",name:"long_description",value:d.long_description,onChange:x,textArea:!0,rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"startDate",className:"block text-sm font-medium text-gray-700",children:"Fecha de inicio"}),e.jsx(h,{id:"startDate",name:"startDate",type:"date",value:d.startDate,onChange:x,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"endDate",className:"block text-sm font-medium text-gray-700",children:"Fecha de fin"}),e.jsx(h,{id:"endDate",name:"endDate",type:"date",value:d.endDate,onChange:x,required:!0})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Productos"}),e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Seleccionar"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Nombre del producto"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Rango de precios (CUP)"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Expandir"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:E.map((r,t)=>e.jsxs($.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"checkbox",checked:y[r.id]||!1,onChange:s=>q(r.id,s.target.checked),className:"focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.name}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:R(r.id)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{type:"button",onClick:()=>U(r.id),className:"text-indigo-600 hover:text-indigo-900",children:w[r.id]?e.jsx(G,{className:"h-5 w-5"}):e.jsx(H,{className:"h-5 w-5"})})})]}),w[r.id]&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Variación"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Precio de oferta"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Moneda"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:r.variations.map((s,o)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.name}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("input",{type:"number",disabled:!y[r.id],onChange:a=>{N(r.id,s.id,a.target.value,g.find(i=>{const n=d.products[t].variations.find(f=>f.id=s.id).currencyId;return n?n==i.id:i.id==5}).id)},className:"mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("select",{disabled:!y[r.id],onChange:a=>{console.log("vas",a.target.value),N(r.id,s.id,"0",a.target.value)},className:"mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm",children:g.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))})})]},s.id))})]})})})]},r.id))})]})]}),e.jsx(B,{type:"submit",disabled:v,children:p?"Actualizar Oferta":"Crear Oferta"})]})}export{ie as default};
