import{ae as Q,r as f,as as U,j as a,ax as p}from"./index-e9055987.js";import{F as X,a as Z,b as x,c as aa}from"./formik.esm-026afa26.js";import{c as b,a as v,d as w,b as y}from"./index.esm-6e43d029.js";import{I as j}from"./Input-cff490ba.js";import{B as _}from"./Button-ba65fcd6.js";import{C as ia}from"./Card-433b6df5.js";import{A as ra}from"./Alert-102e0217.js";import"./index-48bcc748.js";import"./Badge-9568a8b0.js";import{C as g}from"./index-0b16cfb5.js";import"./index-6ec4b8b8.js";import"./Dialog-0f29b530.js";import"./Drawer-1d10f851.js";import"./ScrollBar-7cb0876a.js";import"./FormItem-ea0b05bc.js";import"./index-cba86877.js";import"./index-fd641029.js";import"./toast-38b8809c.js";import"./Skeleton-ede84c2e.js";import"./index-6bfd69bd.js";import"./index-ca92c429.js";import"./Select-3959542b.js";import"./Switcher-fc6ab2a0.js";import"./index-95867d9f.js";import"./index-470afdad.js";import"./Tag-0c9ab60f.js";import"./index-b1813226.js";import"./Tooltip-c9ef7fc2.js";import"./Upload-73c59612.js";import{T as ea}from"./trash-2-8957055b.js";import{C as sa}from"./circle-plus-d9b5bf80.js";import"./Views-51136580.js";import"./isNil-1a93575e.js";import"./get-c3140d19.js";import"./_MapCache-0feb66c1.js";import"./StatusIcon-879e2680.js";import"./index.esm-1ac4f407.js";import"./CloseButton-3f8e850c.js";import"./motion-4061acbd.js";import"./cloneDeep-860e24f8.js";import"./_Uint8Array-1ce16692.js";import"./_getPrototype-241bf201.js";import"./_baseIsEqual-7de73e16.js";import"./useControllableState-461bebfa.js";import"./useRootClose-9a8a5c26.js";import"./useDidUpdate-5adca6d0.js";import"./index-1248b5e2.js";import"./warning-6ee4a779.js";import"./useUncertainRef-63de6025.js";import"./index-8f83c5d8.js";import"./createLucideIcon-35c01f3b.js";const ta={name:"",type:"fixed",supply_variation_id:0,variations:[{cost:0,currency_id:0,description:"",measure:""}],products:[]},oa=b().shape({name:v().required("El nombre es requerido"),type:v().oneOf(["fixed","variable"]).required("El tipo es requerido"),variations:w().of(b().shape({cost:y().min(0,"El costo debe ser mayor o igual a 0").required("El costo es requerido"),currency_id:y().min(1,"Debe seleccionar una moneda").required("La moneda es requerida"),description:v().required("La descripción es requerida"),measure:v().required("La medida es requerida"),product_variations:w().of(b().shape({id:y().required(),required_supplies:y().min(0,"La cantidad requerida debe ser mayor o igual a 0").required("La cantidad requerida es necesaria")}))})).min(1,"Debe haber al menos una variación"),products:w().of(y())}),na=async()=>{const{data:r,error:t}=await p.from("currency").select("*");if(t)throw t;return r},R=async r=>{const{data:t,error:o}=await p.from("supplies").select("*").eq("id",r).single();if(o)throw o;return t},ca=async r=>{const{data:t,error:o}=await p.from("supply_variation").select("*").eq("supply_id",r);if(o)throw o;return t},ma=async r=>{const{data:t,error:o}=await p.from("supplies").upsert(r).select("id").single();if(console.log("SOY",t),o)throw o;return t},la=async(r,t)=>{const{data:o,error:m}=await p.from("supplies").update(t).eq("id",r).single();if(m)throw m;return o},H=async r=>{const{data:t,error:o}=await p.from("supply_variation").upsert(r).select();if(o)throw o;return t},da=async(r,t)=>{const{data:o,error:m}=await p.from("supply_variation").update(t).eq("id",r).single();if(m)throw m;return o};function pa(){const{id:r}=Q(),[t,o]=f.useState(ta),[m,N]=f.useState(!1),[S,q]=f.useState(null),[W,Y]=f.useState([]);f.useState("");const u=U(s=>s.auth.user);f.useEffect(()=>{(async()=>{N(!0);try{const n=await na();Y(n);try{}catch(e){console.error("Error al cargar productos y variaciones:",e)}if(r){const e=await R(r);if(console.log("HOW",u),e.shop_id!==u.shopId)throw new Error("No tienes permiso para editar este suministro");const l=await ca(r);o({id:e.id,name:e.name,type:e.type,supply_variation_id:e.supply_variation_id,variations:l.map(c=>({...c,created_at:new Date(c.created_at).toISOString()}))})}}catch(n){q(n.message||"Error al cargar los datos iniciales")}finally{N(!1)}})()},[r,u.shopId]);const G=async(s,{setSubmitting:n})=>{try{let e;if(s.id){if((await R(s.id)).shop_id!==u.shopId)throw new Error("No tienes permiso para editar este suministro");e=await la(s.id,{name:s.name,type:s.type,shop_id:u.shopId}),console.log(s.variations);for(const c of s.variations)if(c.id){console.log("first1");const{id:d}=c;delete c.id,await da(d,c)}else console.log("first2"),await H([{...c,supply_id:+r}])}else{e=await ma({name:s.name,type:s.type,shop_id:u.shopId}),console.log(e);const l=s.variations.map(c=>({...c,supply_id:e.id}));await H(l)}alert(s.id?"Suministro actualizado":"Suministro creado")}catch(e){q(e.message||"Error al guardar el suministro")}finally{n(!1)}};return m?a.jsx("div",{className:"text-center py-8",children:"Cargando..."}):S?a.jsx(ra,{variant:"default",children:S}):a.jsxs("div",{className:"w-full max-w-2xl mx-auto",children:[a.jsx("h2",{className:"text-2xl font-bold mb-6",children:r?"Editar Suministro":"Crear Suministro"}),a.jsx(X,{initialValues:t,validationSchema:oa,onSubmit:G,enableReinitialize:!0,children:({values:s,errors:n,touched:e,isSubmitting:l,setFieldValue:c})=>a.jsxs(Z,{className:"space-y-6",children:[a.jsxs("div",{children:[a.jsx("label",{htmlFor:"name",children:"Nombre"}),a.jsx(x,{name:"name",as:j,className:"mt-1"}),n.name&&e.name&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.name})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(g,{id:"fixed",checked:s.type==="fixed",onChange:d=>{c("type",d?"fixed":"variable")}}),a.jsx("label",{htmlFor:"fixed",children:"Fijo"})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(g,{id:"variable",checked:s.type==="variable",onChange:d=>{c("type",d?"variable":"fixed")}}),a.jsx("label",{htmlFor:"variable",children:"Variable"})]}),a.jsx(aa,{name:"variations",children:({push:d,remove:J})=>a.jsxs("div",{children:[s.variations.map((ua,i)=>{var C,E,$,F,I,V,k,D,L,A,B,O,z,P,T,M;return a.jsx(ia,{className:"mb-4",children:a.jsxs("div",{className:"pt-6",children:[a.jsxs("h3",{className:"text-lg font-semibold mb-4",children:["Variación ",i+1]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{htmlFor:`variations.${i}.cost`,children:"Costo"}),a.jsx(x,{name:`variations.${i}.cost`,type:"number",as:j,className:"mt-1"}),((E=(C=n.variations)==null?void 0:C[i])==null?void 0:E.cost)&&((F=($=e.variations)==null?void 0:$[i])==null?void 0:F.cost)&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.variations[i].cost})]}),a.jsxs("div",{children:[a.jsx("label",{children:"Moneda"}),a.jsx("div",{className:"space-y-2",children:W.map(h=>a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(g,{id:`currency-${h.id}-${i}`,checked:s.variations[i].currency_id===h.id,onChange:K=>{K?c(`variations.${i}.currency_id`,h.id):c(`variations.${i}.currency_id`,0)}}),a.jsxs("label",{htmlFor:`currency-${h.id}-${i}`,children:[h.name," "]})]},h.id))}),((V=(I=n.variations)==null?void 0:I[i])==null?void 0:V.currency_id)&&((D=(k=e.variations)==null?void 0:k[i])==null?void 0:D.currency_id)&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.variations[i].currency_id})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:`variations.${i}.description`,children:"Descripción"}),a.jsx(x,{name:`variations.${i}.description`,as:j,className:"mt-1"}),((A=(L=n.variations)==null?void 0:L[i])==null?void 0:A.description)&&((O=(B=e.variations)==null?void 0:B[i])==null?void 0:O.description)&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.variations[i].description})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:`variations.${i}.measure`,children:"Medida"}),a.jsx(x,{name:`variations.${i}.measure`,as:j,className:"mt-1"}),((P=(z=n.variations)==null?void 0:z[i])==null?void 0:P.measure)&&((M=(T=e.variations)==null?void 0:T[i])==null?void 0:M.measure)&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:n.variations[i].measure})]}),a.jsxs("div",{children:[a.jsx("label",{children:"Variaciones de Producto"}),a.jsx("div",{className:"space-y-4 mt-2"})]}),i>0&&a.jsxs(_,{type:"button",variant:"default",onClick:()=>J(i),className:"mt-2",children:[a.jsx(ea,{className:"mr-2 h-4 w-4"})," Eliminar Variación"]})]})]})},i)}),a.jsxs(_,{type:"button",variant:"default",onClick:()=>d({cost:0,currency_id:0,description:"",measure:"",created_at:"",supply_id:0}),children:[a.jsx(sa,{className:"mr-2 h-4 w-4"})," Añadir Variación"]})]})}),a.jsx(_,{type:"submit",disabled:l,children:l?"Enviando...":r?"Actualizar Suministro":"Crear Suministro"})]})})]})}function di(){return a.jsx(a.Fragment,{children:a.jsx(pa,{})})}export{di as default};
